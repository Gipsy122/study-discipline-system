<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discipline OS - Fixed</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, set, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG (Ensure these are exactly from your Firebase Project Settings)
        const firebaseConfig = {
            apiKey: "AIzaSyBteFv0YOR7x9YGhcphPr80F01PpLjVKc",
            authDomain: "study-tracker-29.firebaseapp.com",
            databaseURL: "https://study-tracker-29-default-rtdb.firebaseio.com",
            projectId: "study-tracker-29",
            storageBucket: "study-tracker-29.firebasestorage.app",
            messagingSenderId: "183715810841",
            appId: "1:183715810841:web:b037baebaad795de976488"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const statsRef = ref(db, 'discipline/stats');
        const timerRef = ref(db, 'discipline/activeTimer');

        const isAdmin = window.location.search.includes('admin=true');

        // --- BOOTSTRAP SYSTEM (Run this if it doesn't work) ---
        window.systemBoot = () => {
            set(statsRef, { breakPool: 210, buffer: 20, sleepLimit: 7 });
            set(timerRef, { running: false, name: "Idle" });
            alert("System Booted! Data initialized.");
        };

        // --- DATA SYNC ---
        onValue(statsRef, (snapshot) => {
            const d = snapshot.val();
            if (d) {
                document.getElementById('pool').innerText = d.breakPool + "m";
                document.getElementById('buffer').innerText = d.buffer + "m";
                document.getElementById('sleep-val').innerText = d.sleepLimit + "h";
            }
            if(isAdmin) document.getElementById('admin-panel').style.display = 'block';
        });

        // --- TIMER SYNC ---
        let ticker;
        onValue(timerRef, (snapshot) => {
            const t = snapshot.val();
            const box = document.getElementById('active-timer-box');
            clearInterval(ticker);
            if (t && t.running) {
                box.style.display = 'block';
                document.getElementById('timer-name').innerText = t.name;
                ticker = setInterval(() => {
                    const diff = Math.floor((Date.now() - t.startTime) / 1000);
                    const m = Math.floor(diff / 60);
                    const s = diff % 60;
                    document.getElementById('timer-clock').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                }, 1000);
            } else {
                box.style.display = 'none';
            }
        });

        window.toggleTimer = (name, limit, isStrict) => {
            onValue(timerRef, (s) => {
                const t = s.val();
                if (t && t.running) {
                    const elapsed = Math.round((Date.now() - t.startTime) / 60000);
                    applyDeduction(t.name, elapsed, t.limit, t.isStrict);
                    set(timerRef, { running: false });
                } else {
                    set(timerRef, { name, limit, isStrict, startTime: Date.now(), running: true });
                }
            }, { onlyOnce: true });
        };

        function applyDeduction(name, used, limit, isStrict) {
            const overtime = used - limit;
            if (overtime > 0) {
                onValue(statsRef, (s) => {
                    let d = s.val();
                    if (isStrict) d.breakPool -= overtime;
                    else {
                        if (d.buffer >= overtime) d.buffer -= overtime;
                        else { d.breakPool -= (overtime - d.buffer); d.buffer = 0; }
                    }
                    update(statsRef, d);
                }, { onlyOnce: true });
            }
        }
    </script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; padding: 20px; }
        .card { background: #111; border: 1px solid #333; border-radius: 20px; padding: 20px; margin-bottom: 20px; }
        .pool-num { font-size: 4rem; color: #ff3e3e; font-weight: bold; }
        #active-timer-box { background: #fff; color: #000; padding:
