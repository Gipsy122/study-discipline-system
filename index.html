<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discipline OS - Live</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBteFv0YOR7x9YGhcphPr80F01PpLjVKc",
            authDomain: "study-tracker-29.firebaseapp.com",
            databaseURL: "https://study-tracker-29-default-rtdb.firebaseio.com",
            projectId: "study-tracker-29",
            storageBucket: "study-tracker-29.firebasestorage.app",
            messagingSenderId: "183715810841",
            appId: "1:183715810841:web:b037baebaad795de976488"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const statsRef = ref(db, 'discipline/stats');
        const timerRef = ref(db, 'discipline/activeTimer');
        const logRef = ref(db, 'discipline/logs');

        const isAdmin = window.location.search.includes('admin=true');

        // --- LIVE DATA SYNC ---
        onValue(statsRef, (snapshot) => {
            const d = snapshot.val() || { breakPool: 210, buffer: 20, sleepLimit: 7 };
            document.getElementById('pool').innerText = d.breakPool + "m";
            document.getElementById('buffer').innerText = d.buffer + "m";
            document.getElementById('sleep-val').innerText = d.sleepLimit + "h";
            if(isAdmin) document.getElementById('admin-panel').style.display = 'block';
        });

        // --- LIVE STOPWATCH SYNC ---
        onValue(timerRef, (snapshot) => {
            const t = snapshot.val();
            const timerDisplay = document.getElementById('active-timer-box');
            if (t && t.running) {
                timerDisplay.style.display = 'block';
                document.getElementById('timer-name').innerText = t.name;
                updateTicker(t.startTime);
            } else {
                timerDisplay.style.display = 'none';
            }
        });

        let tickerInterval;
        function updateTicker(start) {
            clearInterval(tickerInterval);
            tickerInterval = setInterval(() => {
                const now = Date.now();
                const diff = Math.floor((now - start) / 1000);
                const m = Math.floor(diff / 60);
                const s = diff % 60;
                document.getElementById('timer-clock').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            }, 1000);
        }

        // --- ADMIN ACTIONS ---
        window.toggleTimer = (name, limit, isStrict) => {
            onValue(timerRef, (s) => {
                const t = s.val();
                if (t && t.running) {
                    // STOPPING
                    const elapsed = Math.round((Date.now() - t.startTime) / 60000);
                    processDeduction(t.name, elapsed, t.limit, t.isStrict);
                    set(timerRef, { running: false });
                } else {
                    // STARTING
                    set(timerRef, { name, limit, isStrict, startTime: Date.now(), running: true });
                }
            }, { onlyOnce: true });
        };

        function processDeduction(name, used, limit, isStrict) {
            const overtime = used - limit;
            if (overtime > 0) {
                onValue(statsRef, (s) => {
                    let d = s.val();
                    if (isStrict) {
                        d.breakPool -= overtime;
                    } else {
                        if (d.buffer >= overtime) d.buffer -= overtime;
                        else {
                            d.breakPool -= (overtime - d.buffer);
                            d.buffer = 0;
                        }
                    }
                    update(statsRef, d);
                    push(logRef, { msg: `${name} overtime: ${overtime}m`, time: new Date().toLocaleTimeString() });
                }, { onlyOnce: true });
            }
        }

        window.deductWrongAnswer = () => {
            onValue(statsRef, (s) => {
                let d = s.val();
                d.breakPool -= 2;
                update(statsRef, d);
                push(logRef, { msg: "Wrong Answer penalty: -2m", time: new Date().toLocaleTimeString() });
            }, { onlyOnce: true });
        };
    </script>
    <style>
        :root { --red: #ff3e3e; --bg: #0a0a0a; --card: #161616; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; }
        .stat-card { background: var(--card); border: 1px solid #333; border-radius: 20px; padding: 20px; margin-bottom: 20px; }
        .pool-num { font-size: 4.5rem; font-weight: 800; color: var(--red); }
        #active-timer-box { background: #fff; color: #000; padding: 15px; border-radius: 15px; margin-bottom: 20px; display: none; }
        .admin-panel { display: none; background: #222; padding: 20px; border-radius: 20px; border: 2px solid gold; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin: 5px 0; width: 100%; }
        .btn-start { background: #444; color: #fff; }
        .btn-strict { background: var(--red); color: #fff; }
    </style>
</head>
<body>

    <div class="stat-card">
        <div style="font-size: 0.8rem; letter-spacing: 2px; color: #888;">BREAK POOL</div>
        <div id="pool" class="pool-num">---</div>
        <div class="grid">
            <div style="padding:10px; background:#222; border-radius:10px;">
                <small>BUFFER</small><br><span id="buffer" style="color: #00ff88">--</span>
            </div>
            <div style="padding:10px; background:#222; border-radius:10px;">
                <small>SLEEP</small><br><span id="sleep-val" style="color: #00ff88">--</span>
            </div>
        </div>
    </div>

    <div id="active-timer-box">
        <div id="timer-name" style="font-weight: bold; font-size: 0.8rem;">ACTIVITY</div>
        <div id="timer-clock" style="font-size: 2.5rem; font-weight: bold;">0:00</div>
        <div style="font-size: 0.7rem;">LIVE SYNC ACTIVE</div>
    </div>

    <div id="admin-panel" class="admin-panel">
        <h3 style="color: gold; margin-top: 0;">STOPWATCHES</h3>
        <button class="btn-start" onclick="toggleTimer('Bath', 30, false)">BATH (30m Limit)</button>
        <button class="btn-start" onclick="toggleTimer('Food', 45, false)">FOOD (45m Limit)</button>
        <button class="btn-start" onclick="toggleTimer('Haga', 30, false)">HAGA (30m Limit)</button>
        <button class="btn-strict" onclick="toggleTimer('Sleep', 420, true)">SLEEP (7h Strict)</button>
        <hr>
        <button class="btn-strict" onclick="deductWrongAnswer()">WRONG ANSWER (-2m)</button>
    </div>

</body>
</html>
