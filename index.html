<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discipline OS</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBteFv0YOR7x9YGhcphPr80F01PpLjVKc",
            authDomain: "study-tracker-29.firebaseapp.com",
            databaseURL: "https://study-tracker-29-default-rtdb.firebaseio.com",
            projectId: "study-tracker-29",
            storageBucket: "study-tracker-29.firebasestorage.app",
            messagingSenderId: "183715810841",
            appId: "1:183715810841:web:b037baebaad795de976488"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const statsRef = ref(db, 'discipline/stats');
        const couponRef = ref(db, 'discipline/inventory');
        const logRef = ref(db, 'discipline/logs');

        const isAdmin = window.location.search.includes('admin=true');

        // SYNC UI
        onValue(statsRef, (snapshot) => {
            const d = snapshot.val() || { breakPool: 210, buffer: 20, sleepLimit: 7 };
            document.getElementById('pool').innerText = d.breakPool + "m";
            document.getElementById('buffer').innerText = d.buffer + "m";
            document.getElementById('sleep').innerText = d.sleepLimit + "h";
            if(isAdmin) document.getElementById('admin-panel').style.display = 'block';
        });

        // SYNC COUPONS (Visible to both, but only student can click)
        onValue(couponRef, (snapshot) => {
            const list = document.getElementById('coupons');
            list.innerHTML = "";
            const data = snapshot.val();
            for(let id in data) {
                if(!data[id].used) {
                    let div = document.createElement('div');
                    div.className = "coupon";
                    div.innerHTML = `üéüÔ∏è <b>${data[id].name}</b><br><small>${data[id].desc}</small>`;
                    if(!isAdmin) {
                        div.style.cursor = "pointer";
                        div.onclick = () => redeem(id, data[id]);
                    }
                    list.appendChild(div);
                }
            }
        });

        // AUDIT LOGIC (Triggered by Admin Buttons)
        window.auditBreak = (category, limit, isStrict) => {
            let used = prompt(`How many minutes did she spend on ${category}?`);
            if(!used) return;
            let overtime = parseInt(used) - limit;

            if(overtime > 0) {
                onValue(statsRef, (s) => {
                    let data = s.val();
                    if(isStrict) {
                        data.breakPool -= overtime;
                    } else {
                        if(data.buffer >= overtime) {
                            data.buffer -= overtime;
                        } else {
                            let overflow = overtime - data.buffer;
                            data.buffer = 0;
                            data.breakPool -= overflow;
                        }
                    }
                    update(statsRef, data);
                    push(logRef, { msg: `${category} overtime: ${overtime}m deducted.`, time: new Date().toLocaleTimeString() });
                }, {onlyOnce: true});
            }
        };

        window.grantCoupon = (name, type, val, desc) => {
            push(couponRef, { name, type, value: val, desc, used: false });
        };

        window.redeem = (id, coupon) => {
            onValue(statsRef, (s) => {
                let d = s.val();
                if (coupon.type === 'sleep') d.sleepLimit = coupon.value;
                if (coupon.type === 'break') d.breakPool += coupon.value;
                update(statsRef, d);
                update(ref(db, `discipline/inventory/${id}`), { used: true });
                alert("Coupon Redeemed!");
            }, {onlyOnce: true});
        };

        window.resetDaily = () => {
            if(confirm("Reset for the day?")) {
                update(statsRef, { breakPool: 210, buffer: 20, sleepLimit: 7 });
                set(logRef, null); // Clear logs
            }
        };
    </script>
    <style>
        :root { --bg: #000; --accent: #ff3e3e; --gold: #ffd700; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; padding: 20px; }
        .stat-card { background: #111; border: 1px solid #333; border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 15px; }
        .pool-text { font-size: 4rem; font-weight: bold; color: var(--accent); }
        .admin-section { display: none; border: 2px solid var(--gold); padding: 15px; border-radius: 15px; margin-top: 20px; }
        .coupon { border: 2px dashed var(--gold); color: var(--gold); padding: 15px; border-radius: 10px; margin: 10px 0; }
        button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-audit { background: #eee; color: #000; }
        .btn-reward { background: var(--gold); color: #000; }
        .btn-reset { background: #333; color: #888; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="stat-card">
        <div style="font-size: 0.8rem; color: #888;">BREAK POOL</div>
        <div id="pool" class="pool-text">210m</div>
        <div style="display: flex; justify-content: space-around; margin-top: 10px;">
            <div><small>BUFFER</small><br><span id="buffer">20m</span></div>
            <div><small>SLEEP</small><br><span id="sleep">7h</span></div>
        </div>
    </div>

    <div id="coupons"></div>

    <div id="admin-panel" class="admin-section">
        <h3 style="color: var(--gold); margin-top:0;">ADMIN CONTROLS</h3>
        <button class="btn-audit" onclick="auditBreak('Bath', 30, false)">AUDIT BATH (30m)</button>
        <button class="btn-audit" onclick="auditBreak('Food', 45, false)">AUDIT FOOD (45m)</button>
        <button class="btn-audit" onclick="auditBreak('Sleep', 420, true)">AUDIT SLEEP (7h)</button>
        
        <h3 style="color: var(--gold);">REWARDS</h3>
        <button class="btn-reward" onclick="grantCoupon('Sleep Reward', 'sleep', 8, '8 hours of sleep tonight')">GRANT SLEEP COUPON</button>
        <button class="btn-reward" onclick="grantCoupon('Extra Break', 'break', 30, '+30 mins to break pool')">GRANT +30M BREAK</button>
        
        <button class="btn-reset" onclick="resetDaily()">DAILY RESET</button>
    </div>

</body>
</html>
